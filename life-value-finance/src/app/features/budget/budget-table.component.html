<div class="table-container">
  

  <!-- Grid Card (Desktop Only) -->
  <div class="grid-card desktop-view">
    <div class="card-header" [class.history-header]="!isCurrentMonth()">
      <div class="header-content">
          <div class="title-group">
            <h3>Budget Breakdown</h3>
            <div class="month-nav">
              <button class="nav-btn" (click)="prevMonth()" title="Previous Month">
                <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="currentColor"><path d="M560-240 320-480l240-240 56 56-184 184 184 184-56 56Z"/></svg>
              </button>
              <span class="active-month">{{ viewedMonth() | date:'MMMM yyyy' }}</span>
              <button class="nav-btn" (click)="nextMonth()" [disabled]="isCurrentMonth()" title="Next Month">
                <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="currentColor"><path d="M504-480 320-664l56-56 240 240-240 240-56-56 184-184Z"/></svg>
              </button>
            </div>
          </div>
          <span class="row-count">{{ expenses().length }} Items</span>
           @if (!isCurrentMonth()) {
              <span class="history-badge">HISTORY</span>
            }
      </div>
      @if (isCurrentMonth()) {
        <button class="btn-archive" (click)="startNewMonth()" title="Archive current month and start new">
          üìÖ Start New Month
        </button>
      }
    </div>

    <!-- Savings Warning Banner -->
    @if (savingsStatus().hasDeficit) {
    <div class="savings-alert">
        <div class="alert-icon">‚ö†Ô∏è</div>
        <div class="alert-content">
            <h4>Savings Overcommitted</h4>
            <p>
                You planned <strong>${{ savingsStatus().plannedSavings | number:'1.2-2' }}</strong> in savings, 
                but high expenses leave only <strong>${{ savingsStatus().availableForSavings | number:'1.2-2' }}</strong> available.
                <br/>
                Your savings are <strong>{{ savingsStatus().percentFunded | number:'1.0-1' }}% funded</strong>. 
                Consider reducing variable expenses or adjusting savings goals.
            </p>
        </div>
    </div>
    }
    
    <div class="grid-container">
      @if (isBrowser) {
      <ag-grid-angular
        [class]="themeService.isDark() ? 'ag-theme-quartz-dark expense-grid' : 'ag-theme-quartz expense-grid'"
        [rowData]="expenses()"
        [columnDefs]="colDefs"
        [defaultColDef]="defaultColDef"
        [gridOptions]="gridOptions"
        [theme]="'legacy'"
        (cellValueChanged)="onCellValueChanged($event)"
        (cellClicked)="onCellClicked($event)" 
      >
      </ag-grid-angular>
      }
    </div>
  </div>

  <!-- Mobile Card List View -->
  <div class="mobile-budget-list mobile-view">
    <div class="mobile-header" [class.history-header]="!isCurrentMonth()">
        <div class="header-top">
            <h3>{{ filteredExpenses().length }} Items</h3>
            <div class="month-nav-mobile">
                <button class="nav-btn" (click)="prevMonth()" title="Previous Month">
                  <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="currentColor"><path d="M560-240 320-480l240-240 56 56-184 184 184 184-56 56Z"/></svg>
                </button>
                <span class="active-month">{{ viewedMonth() | date:'MMM yyyy' }}</span>
                <button class="nav-btn" (click)="nextMonth()" [disabled]="isCurrentMonth()" title="Next Month">
                  <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="currentColor"><path d="M504-480 320-664l56-56 240 240-240 240-56-56 184-184Z"/></svg>
                </button>
            </div>
        </div>
        @if (isCurrentMonth()) {
            <button class="btn-archive-mobile" (click)="startNewMonth()">
                üìÖ New Month
            </button>
        } @else {
            <div class="history-badge-mobile">HISTORY VIEW</div>
        }
    </div>

    <!-- Savings Warning Banner (Mobile) -->
    @if (savingsStatus().hasDeficit) {
    <div class="savings-alert mobile-alert">
        <div class="alert-icon">‚ö†Ô∏è</div>
        <div class="alert-content">
            <h4>Savings At Risk</h4>
            <p>
                Only <strong>${{ savingsStatus().availableForSavings | number:'1.2-2' }}</strong> available for your 
                <strong>${{ savingsStatus().plannedSavings | number:'1.2-2' }}</strong> savings goal.
            </p>
        </div>
    </div>
    }

    <div class="mobile-filters">
        <app-single-select
            [options]="priorityOptions"
            [value]="filterPriority() || 'All'"
            variant="dot"
            (valueChange)="filterPriority.set($event)"
            placeholder="All Priority">
        </app-single-select>
        
        <app-single-select
            [options]="typeOptions"
            [value]="filterType() || 'All'"
            variant="dot"
            (valueChange)="filterType.set($event)"
            placeholder="All Types">
        </app-single-select>
    </div>

    <div class="cards-scroll-container">
        @if (filteredExpenses().length === 0) {
            <div class="empty-state">
                <div class="empty-icon">üìù</div>
                <h4>No Items found</h4>
                <p>Start adding expenses to see them listed here.</p>
            </div>
        }

        @for (item of filteredExpenses(); track item.id) {
        <div class="budget-card" [class.unfunded-savings]="savingsStatus().hasDeficit && item.type === 'Saving'">
            <!-- Show Warning on Savings Card -->
            @if (savingsStatus().hasDeficit && item.type === 'Saving') {
                <div class="card-warning-stripe">‚ö†Ô∏è Partially Funded ({{ savingsStatus().percentFunded | number:'1.0-0' }}%)</div>
            }
            
            <div class="card-main">
                <div class="card-top">
                    <input type="text" 
                        class="category-name-input" 
                        [value]="item.name" 
                        (change)="onMobileNameChange(item, $event)"
                        placeholder="Item Name">
                    
                    <div class="amount-group">
                        <div class="qty-wrapper">
                            <span>x</span>
                            <input type="number" 
                                [value]="item.quantity || 1" 
                                (change)="onMobileQuantityChange(item, $event)" 
                                class="qty-input"
                                min="1"
                                title="Quantity">
                        </div>
                        <span class="currency-symbol">$</span>
                        <input type="number" 
                            [value]="item.amount" 
                            (change)="onMobileAmountChange(item, $event)" 
                            class="amount-input"
                            step="0.01">
                    </div>
                </div>
                
                <div class="card-meta">
                    <div class="mobile-select-group">
                        <label>Importance:</label>
                        <app-single-select
                            [options]="priorityOptions"
                            [value]="item.priority"
                            variant="dot"
                            (valueChange)="updateItemPriority(item, $event)"
                            class="inline-single-select">
                        </app-single-select>
                    </div>
                </div>
            </div>
            
            <div class="card-footer">
                <div class="mobile-select-group">
                    <label>Type:</label>
                    <app-single-select
                        [options]="typeOptions"
                        [value]="item.type"
                        variant="badge"
                        (valueChange)="updateItemType(item, $event)"
                        class="inline-single-select">
                    </app-single-select>
                </div>
                
                <button class="btn-delete-mobile" (click)="deleteMobile(item.id, item.name)" aria-label="Delete">
                    üóëÔ∏è
                </button>
            </div>
        </div>
    }
    </div>
  </div>
</div>
