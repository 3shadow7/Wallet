<div class="history-container">
    <header>
      <h1>üìä Monthly History & Savings Analysis</h1>
    </header>
    
    <!-- Stats Overview -->
    <div class="stats-grid">
      <div class="stat-card">
          <h3>Total Savings</h3>
          <span class="value">{{ totalSavings() | currency }}</span>
      </div>
      <div class="stat-card">
          <h3>Avg Savings Rate</h3>
          <span class="value">{{ avgSavingsRate() | number:'1.1-1' }}%</span>
      </div>
      <div class="stat-card">
          <h3>Best Month</h3>
          <div class="mini-detail">
              <span class="value">{{ bestMonth()?.month || '--' }}</span>
              <span class="sub" *ngIf="bestMonth()">{{ bestMonth()?.transferredToSavings | currency }} saved</span>
          </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-row">
      <div class="chart-card">
          <h3>Savings Growth</h3>
          <div #savingsChart></div>
      </div>
      <div class="chart-card Cash-Flow-Breakdown">
          <h3>Monthly Cash Flow Breakdown</h3>
          <div #expensesChart></div>
      </div>
      <div class="chart-card full-width">
          <div class="chart-header">
              <h3>Expense Composition Analysis</h3>
              <div class="toggle-group">
                  <button [class.active]="breakdownMode === 'type'" (click)="setBreakdownMode('type')">By Type</button>
                  <button [class.active]="breakdownMode === 'priority'" (click)="setBreakdownMode('priority')">By Priority</button>
              </div>
          </div>
          <div #breakdownChart></div>
      </div>

      <!-- New Section: Item Drilldown -->
      <div class="chart-card full-width">
          <div class="chart-header treemap-header">
              <h3>Detailed Item Composition (Treemap)</h3>
              
              <!-- Filters Row: Year | Type | Priority -->
              <div class="filter-controls">
                  <div class="control-group">
                      <label>Year:</label>
                      <app-single-select
                          [options]="availableYears()"
                          [value]="selectedYear()"
                          (valueChange)="selectedYear.set($event)"
                          placeholder="Select Year">
                      </app-single-select>
                  </div>

                  <div class="control-group">
                      <label>Type:</label>
                      <app-multi-select 
                          [options]="availableTypes" 
                          [selected]="filterType()"
                          (selectionChange)="filterType.set($event)"
                          placeholder="Select Types"
                          variant="badge">
                      </app-multi-select>
                  </div>

                  <div class="control-group">
                      <label>Priority:</label>
                      <app-multi-select 
                          [options]="availablePriorities" 
                          [selected]="filterPriority()"
                          (selectionChange)="filterPriority.set($event)"
                          placeholder="Select Priority">
                      </app-multi-select>
                  </div>
              </div>

              <!-- Month Selection Slider -->
              <div class="month-selector">
                      <span class="label">Timeline:</span>
                      <div class="slider-wrapper">
                          <app-month-slider (rangeChange)="onTimeRangeChange($event)"></app-month-slider>
                      </div>
              </div>
          </div>
          <div #itemChart></div>
      </div>
    </div>

    <!-- Detailed History Table (Desktop) -->
    <div class="table-card desktop-view">
      <h3>Detailed Monthly Log</h3>
      @if (isBrowser) {
      <ag-grid-angular
        [class]="themeService.isDark() ? 'ag-theme-quartz-dark history-grid' : 'ag-theme-quartz history-grid'"
        [rowData]="history()"
        [columnDefs]="colDefs"
        [defaultColDef]="defaultColDef"
        domLayout="autoHeight"
        [theme]="'legacy'"
      >
      </ag-grid-angular>
      }
    </div>

    <!-- Mobile History Cards -->
    <div class="mobile-history-list mobile-view">
        <div class="mobile-header">
            <h3>Monthly Log</h3>
        </div>

        <div class="mobile-scroll-container">
            @if (history().length === 0) {
                <div class="empty-state">
                    <div class="empty-icon">üìä</div>
                    <h4>No History Yet</h4>
                    <p>Complete a month to see your financial log here.</p>
                </div>
            }

            @for (item of history(); track item.date) {
                <div class="history-card">
                    <div class="card-header">
                        <span class="month-label">{{ item.month }}</span>
                        <span class="balance-badge">
                            <span class="label">Total Balance:</span>
                            <span class="val">{{ item.savingsTotalAfterTransfer | currency:'USD':'symbol':'1.0-0' }}</span>
                        </span>
                    </div>
                    
                    <div class="card-grid">
                        <!-- Income & Expense Row -->
                        <div class="stat-group">
                            <span class="label">Income</span>
                            <span class="val income">{{ item.income | currency:'USD':'symbol':'1.0-0' }}</span>
                        </div>
                        <div class="stat-group">
                            <span class="label">Expenses</span>
                            <span class="val expense">{{ item.expenses | currency:'USD':'symbol':'1.0-0' }}</span>
                        </div>

                        <!-- Target & Actual Row -->
                        <div class="stat-group">
                            <span class="label">Target Savings</span>
                            <span class="val target">{{ item.plannedSavings | currency:'USD':'symbol':'1.0-0' }}</span>
                        </div>
                        <div class="stat-group">
                            <span class="label">Actual Saved</span>
                            <span class="val saved" [class.deficit]="item.transferredToSavings < 0">{{ item.transferredToSavings | currency:'USD':'symbol':'1.0-0' }}</span>
                        </div>
                    </div>

                    <!-- Savings Impact Section -->
                    <div class="impact-section" [class.negative]="item.freeMoney < 0" [class.positive]="item.freeMoney >= 0">
                        <div class="impact-header">
                            <span class="label">Free Money / Impact</span>
                            <span class="val">{{ item.freeMoney | currency }}</span>
                        </div>
                        @if (item.freeMoney < 0) {
                            <div class="impact-details">
                                @if ((item.plannedSavings || 0) > 0) {
                                    <span class="warning">‚ö†Ô∏è Reduced Goal by {{ ((Math.abs(item.freeMoney) / item.plannedSavings) * 100) | number:'1.0-1' }}%</span>
                                } @else {
                                    <span class="warning">‚ö†Ô∏è Dipped into Savings</span>
                                }
                            </div>
                        }
                    </div>

                    <!-- Manual Additions -->
                    @if (item.manualAdded && item.manualAdded !== 0) {
                        <div class="manual-add-row">
                            <span class="icon">‚ûï</span>
                            <span>Direct Add: {{ item.manualAdded | currency }}</span>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
  </div>